

NB: THIS IS NOT IN A FUNCTION YET


# this script is for the multiple choice grid (table) questions where more than one option can be selected. It plots two variables (e.g. combined with a demographic)
# it plots counts or relative frequencies for more than one condition of the data (e.g. options selected for 'during research' and options selected for 'after research'). The plots are arranged to show in one plotting window

# the cleaned data files and key files are read in using the script readFilesCleanData.R


### load packages -------

library(tidyverse)
library(kableExtra)
library(data.table)
library(ggpubr)


#plotMultichoiceGrid2var <- function(question_name) {

# Extract the Question answers and key from data_all and data_key and draw a plot

## Question answers
# ==================

# get the question answers: select all of ques level 2 nos for the ques level 1 identified in question_name
question_numbers_level2 <- data_key %>% filter(ques_level1 == "Q11") # for function, replace "Q11" with question_name
question_numbers_level2 <- question_numbers_level2$ques_level2
answers_mcg <- data_all %>% select(URN, question_numbers_level2)

# get the question key
question_key_mcg <- data_key %>% filter(ques_level1 == "Q11") %>%
   select("ques_level2", "question", "multiple_choice_grid_options", "choice_options_text")

# split answers_mcg by the letter in the column names (e.g. a, b, etc)
mcg_answers_a <- answers_mcg %>% select("URN", contains("a"))
mcg_answers_b <- answers_mcg %>% select("URN", contains("b"))

# split the question_key using group_split on the multiple_choice_grid_options - this allows a tibble for one of the ques level 2 options to be extracted (e.g. before research, after research)
mcg_key <- question_key_mcg %>% 
   group_split(multiple_choice_grid_options)

#mcg_key[[1]]
#mcg_key[[2]]

# get the names of the tibbles for the multiple choice options
name_one <- mcg_key[[1]][1,3]
name_two <- mcg_key[[2]][1,3]

# rename the column headings containing ques nos in answers with the choice options text
colnames(mcg_answers_a) <- c("URN", mcg_key[[1]]$choice_options_text)
colnames(mcg_answers_b) <- c("URN", mcg_key[[2]]$choice_options_text)


## Demographics (or any other multi choice single option question)
# ==================
# select for the demographics data
answers_demographic <- data_all %>% select(URN, Q1) # for function replace Q1 with demographic

## get question key for the demographic and left join onto the answers_demographic
# question key for the demographic
question_key_demographic <- data_key %>% filter(ques_level1 == "Q1") %>%
   select("choice_options_text", "choice_options_no")


# Join the demographic answers with the question_keys
# ==================
by_condition <- "choice_options_no" # The column to match in the question_key
names(by_condition) <- "Q1"
qdata_to_plot <- left_join(answers_demographic, question_key_demographic, by = by_condition)


# join the key/choice options text to answers files a & b using URN numbers
# ==================
data_total_a <- left_join(qdata_to_plot, mcg_answers_a, by = "URN")
data_total_b <- left_join(qdata_to_plot, mcg_answers_b, by = "URN")


# plot count data and the fill is the choice_options_text

df_plot_a <- data_total_a[, -c(1:2)]
df_plot_b <- data_total_b[, -c(1:2)]

df_plot_a <- df_plot_a %>% pivot_longer(
   cols = !choice_options_text,
   names_to = "option",
   values_to = "counts")

df_plot_b <- df_plot_b %>% pivot_longer(
   cols = !choice_options_text,
   names_to = "option",
   values_to = "counts")

# plot with ggplot
## counts
p1 <- ggplot(df_plot_a, aes(x=counts, y=option, fill=choice_options_text)) +
geom_bar(stat = "identity") +
   labs(title = name_two, x = " ", y = "", fill = " ")

p2 <- ggplot(df_plot_b, aes(x=counts, y=option, fill=choice_options_text)) +
geom_bar(stat = "identity") +
   labs(title = name_one, x = "Count ", y = "", fill = " ")


## to show percent stacked barplot - plots, but check correct
#p1 <- ggplot(df_plot_a, aes(x=counts, y=option, fill=choice_options_text)) +
#   geom_bar(position="fill", stat = "identity", width=0.7) + 
#   labs(title = name_two, x = " ", y = " ", fill = " ")

#p2 <- ggplot(df_plot_b, aes(x=counts, y=option, fill=choice_options_text)) +
#   geom_bar(position="fill", stat = "identity", width=0.7) + 
#   labs(title = name_one, x = "Frequency", y = " ", fill = " ")

figure <- ggarrange(p1, p2,
                    ncol = 1, nrow = 2)
figure


#}

#plotMultichoiceGrid2var("Q60", "Q1")
